<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>文件上传界面</title>
</head>
<body>
<form id="upload_form" class="form-horizontal" style="padding: 8px" role="form" onsubmit="return false;" enctype="multipart/form-data">
    <div id="upload_alert"></div>
    <div class="form-group" title="用户访问密钥">
        <div class="col-md-2 form-group">
            <label class="control-label" for="key"><label style="color: red">*</label>访问秘钥：</label>
        </div>
        <div class="col-lg-7 form-group">
            <input class="form-control" type="password" id="key" name="key" placeholder="请输入访问秘钥" required autofocus>
        </div>
        <div class="col-lg-3 checkbox" style="float: right">
            <input type="checkbox" id="remember"><label>记住秘钥</label>
        </div>
    </div>
    <div class="form-group" title="选择100Mb以内的文件">
        <label class="control-label" for="file"><label style="color: red">*</label>选择文件(100Mb以内)：</label>
        <input type="file" id="file" name="file" required>
    </div>
    <div class="form-group" title="选择文件后可以修改保存的文件名称，文件名控制在25个字符内">
        <label class="control-label" for="fileName">文件名称：</label>
        <input class="form-control" type="text" id="fileName" name="fileName" placeholder="请输入文件名称（选填）例：壁纸123" oninput="titleInput('fileName','fileName_tips',25)" onchange="limitInput('fileName',25)" >
        <p class="help-block" id="fileName_tips"></p>
    </div>
    <div class="form-group" title="输入文件保存的目录，默认根据文件类型进行保存">
        <label class="control-label" for="path">保存路径：</label>
        <input class="form-control" type="text" id="path" name="path" placeholder="请输入保存路径（选填）例：image" onchange="limitInput('path',20)" >
    </div>
    <div>
        <img id="wait_icon" src="/static/img/循环.gif" style="zoom:0.2;" hidden="hidden">
        <input type="submit" id="btn_upload" class="btn btn-search" onclick="sub1()" value="上传">
        <input type="reset" class="btn btn-default" value="重置">
    </div>
    <script>
        $("#file").change(function () {
            var f = document.getElementById("file").files;
            var name=f[0].name;
            var size=f[0].size;
            var type=f[0].type;
            var fName=name.substring(0,name.lastIndexOf(".")).length>20?name.substring(0,20):name.substring(0,name.lastIndexOf("."));
            $("#fileName").val(fName);
            // $("#path").val(size);
            if ((size/1048576)>=100) {
                alert("警告：文件大小超过100Mb最大限制！");
                $("#file").val(null);
                $("#fileName").val(null);
                // $("#path").val(null);
            }
        });
        function sub1() {
            var key=$("#key").val();
            var file=$("#file").val();
            if (key.length>0){
                if (file.length>0){
                    $("#wait_icon").show();
                    $("#btn_upload").attr('disabled',true);
                    $("#btn_upload").val('上传中...');
                    upload(key);
                } else {
                    alert("请选择文件");
                }
            } else {
                alert("请输入秘钥");
            }
            return false;
        }
        function upload(key) {
            var form = new FormData(document.getElementById("upload_form"));
            $.ajax({
                url:"/upload/saveMulFile",
                type:"post",
                dataType:"json",
                data: form,
                processData: false,
                contentType: false,
                xhr: function() { //用以显示上传进度
                    var xhr = $.ajaxSettings.xhr();
                    if (xhr.upload) {
                        xhr.upload.addEventListener('progress', function(event) {
                            var percent = Math.floor(event.loaded / event.total * 100);
                            $("#btn_upload").val(percent-1 + "%"+'上传中...');
                        }, false);
                    }
                    return xhr
                },
                success:function (d) {
                    // console.log(d);
                    // alert(d.message);
                    var html="";
                    switch (d.code) {
                        case 200:
                            html+='<div  class="alert alert-success fade in">';
                            break;
                        case 500:
                            html+='<div  class="alert alert-danger fade in">';
                            break;
                        case 404:
                            html+='<div  class="alert alert-warning fade in">';
                            break;
                        case 100:
                            html+='<div  class="alert alert-info fade in">';
                            break;
                    }
                    html+='<button type="button" class="close close-sm" data-dismiss="alert">' +
                        '      <i class="fa fa-times"></i>' +
                        '  </button>' +
                        '<h4><strong>'+d.title+'</strong></h4>' ;
                    if (d.code==200){
                        html+='<label><a target="_blank" href="/download/show/'+d.message+'">'+d.message+'</a></label>' ;
                    } else {
                        html+='<label>'+d.message+'</label>' ;
                    }
                    html+= '</div>';
                    $("#upload_alert").html(html);
                    reset();
                    $("#btn_upload").attr("disabled",false);
                    $("#btn_upload").val('上传');
                    $("#wait_icon").hide();
                },
                error:function (e) {
                    $("#btn_upload").attr("disabled",false);
                    $("#btn_upload").val('上传');
                    $("#wait_icon").hide();
                    alert("上传错误："+e);
                }
            })
        }

        function reset() {
           if (!$("#remember").is(':checked'))  {
               $("#key").val(null);
           }
            $("#file").val(null);
            $("#fileName").val(null);
            $("#path").val(null);
        }
    </script>
</form>
</body>
</html>