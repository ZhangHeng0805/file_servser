<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>文件查找</title>
    <style>
    </style>
</head>
<body>
<div id="findFileList">
    <div class="row">
        <form class="form-inline" role="form" onsubmit="return false;">
            <div class="row">
                <div class="form-group col-md-4" title="用户访问密钥">
                    <label class="control-label" for="keys" id="lab_keys"><label
                            style="color: red">*</label>秘钥：</label>
                    <input class="form-control" type="password" id="keys" placeholder="请输入访问秘钥" required autofocus>
                </div>
                <div class="form-group col-md-4" title="选择查找路径">
                    <label class="control-label" for="type" id="lab_type"><label
                            style="color: red">*</label>选择类型：</label>
                    <select class="form-control" id="type" required>
                        <option value="$all$">全部</option>
                    </select>
                </div>
                <div id="query_file" class="form-group col-md-4" title="查询文件">
                    <label class="control-label" for="query_name" id="lab_query">文件名：</label>
                    <input class="form-control" type="text" id="query_name" placeholder="请输入查找的文件名">
                </div>
            </div>
            <!--            <script>-->
            <!--                $("#lab_keys").css("font-size", $("#keys").height() / 1.5);-->
            <!--                $("#lab_type").css("font-size", $("#type").height() / 1.5);-->
            <!--            </script>-->
            <hr>
            <input type="submit" class="btn btn-warning btn-block text-center" id="btn_sub2" onclick="sub2()"
                   value="查询">
        </form>
    </div>
    <hr>
    <h4 align="center" id="files_num"></h4>
    <div id="files_result">
    </div>
    <a class="btn btn-info" style="z-index: 9999; position: fixed ! important; right: 2%; bottom: 3%;"
       onclick="scrollToTop()">
        <i class="fa fa-angle-double-up"></i>顶部
    </a>
    <script>
        var TYPE;
        var Data = null;

        function getAllFileType() {
            $.ajax({
                url: "/download/getAllFileType",
                method: "post",
                dataType: "json",
                success: function (d) {
                    var html = "";
                    for (var i = 0; i < d.length; i++) {
                        html += '<option value="' + d[i].message + '">' + d[i].title + '</option>';
                    }
                    $("#type").html(html);
                    set_select_checked("type", TYPE);
                },
                error: function (e) {
                    alert("类型查询错误：" + e);
                }
            });
            if (isData(Data)) {
                $("#query_file").show();
                $("#query_file").val('');
            } else {
                $("#query_file").hide();
            }
        }

        function isData(data) {
            return data != null && data.length > 0 && data[0].code == 200;
        }

        getAllFileType();

        function sub2() {
            let query_name = $("#query_name").val();
            if (query_name != null && query_name.length > 0) {
                if (TYPE != $("#type").val()) {
                    set_select_checked("type", TYPE);
                }
                handle(fuzzyQuery(Data, query_name));
                return;
            }

            if ($("#keys").val().length > 0) {
                $("#btn_sub2").attr('disabled', true);
                $.ajax({
                    url: "/download/findFileList",
                    method: "post",
                    dataType: "json",
                    data: {
                        key: $("#keys").val(),
                        type: $("#type").val()
                    },
                    success: function (d) {
                        // console.log(d);
                        if (isData(d)) {
                            Data = d;
                            TYPE = $("#type").val();
                        }else {
                            if (TYPE != $("#type").val())
                                set_select_checked("type", TYPE);
                        }
                        //处理数据
                        handle(d);
                        //刷新下拉框数据
                        getAllFileType();
                        $("#btn_sub2").attr('disabled', false);
                    },
                    error: function (e) {
                        $("#btn_sub2").attr('disabled', false);
                        alert("结果查询错误：" + e);
                        console.log(e);
                    }
                })
            } else {
                alert("请输入秘钥")
            }

        }

        function handle(d) {
            var html = "";
            var icon = "/static/img/unknown.png";
            var title = "";
            let update_time = "";
            let type = "";
            let auth = "";
            var size = 0;
            for (var i = 0; i < d.length; i++) {
                var msg = d[i];
                update_time = msg.obj == null ? "" : msg.obj.update_time;
                type = msg.obj == null ? "" : msg.obj.type;
                title = msg.title;
                switch (msg.code) {
                    case 200:
                        switch (type) {
                            case "text":
                                icon = "/static/img/text.png";
                                break;
                            case "video":
                                icon = "/static/img/video.png";
                                break;
                            case "audio":
                                icon = "/static/img/audio.png";
                                break;
                            case "image":
                                icon = "/download/show/" + encodeURI(msg.message);
                                break;
                            case "application":
                                icon = "/static/img/application.png";
                                break;
                            default:
                                icon = "/static/img/unknown.png";
                                break;
                        }
                        title = msg.obj == null ? "" : msg.obj.name;
                        size = msg.obj == null ? "" : getFileSizeFormat(msg.obj.size);
                        html += '<div class="panel panel-success">';
                        break;
                    case 500:
                        html += '<div class="panel panel-danger">';
                        break;
                    case 404:
                        html += '<div class="panel panel-warning">';
                        break;
                }
                html += '<div class="panel-heading">' +
                    '<img src="' + icon + '" style="height: 40px;margin-right: 15px;box-shadow:0 0 10px black;">' +
                    '<label style="margin-right: 25px">' + title + '</label>' +
                    '<label class="label label-primary">' + size + '</label>' +
                    '<code>' + update_time + '</code>' +
                    '</div>' +
                    '<div class="panel-body" style="background-color: #afd9ee">' +
                    // '<label class="control-label" for="type">文件路径：</label>' +
                    '    <div class="form-group">' +
                    '       <input class="form-control file_path_' + i + '" type="text" readonly>' +
                    '     </div>';
                if (msg.code == 200) {
                    html += '<div class="form-group">' +
                        '<div class="btn-group"><button data-toggle="dropdown" class="btn btn-search dropdown-toggle btn_' + i + '" ">复制链接<span class="caret"></span></button>' +
                        '<ul role="menu" class="dropdown-menu">' +
                        '<li><a id="c1_' + i + '" onclick="copeText(\'c1_' + i + '\');" title="普通的单个文件直接下载">普通下载地址</a></li>' +
                        '<li><a id="c2_' + i + '" onclick="copeText(\'c2_' + i + '\');" title="断点分片快速下载，需要下载端支持">分片下载地址</a></li>' +
                        '</ul></div>';
                    html += '<div class="btn-group"><a class="btn btn-primary" target="_blank" id="btn' + i + '_download">直接访问</a></div>';
                    auth = msg.obj == null ? "" : msg.obj.auth;
                    if (auth != null && auth.length > 0 && auth == "admin") {
                        html += '<div class="btn-group"><a class="btn btn-danger" target="_blank" onclick="del(\'' + msg.message + '\')">删除文件</a></div>';
                    }
                }
                html += '</div></div></div>';
            }
            $("#files_result").html(html);
            $("#files_num").html('总计:' + d.length + '个文件');
            initData(d);
        }

        function initData(d) {
            for (var i = 0; i < d.length; i++) {
                $(".file_path_" + i).val(d[i].message);
                let arr = d[i].message.split("/");
                for (let n = 0; n < arr.length; n++) {
                    arr[n] = encodeURIComponent(arr[n]);
                }
                let path = arr.join("/");
                let url1 = "http://" + window.location.host + "/download/show/" + path;
                let url2 = "http://" + window.location.host + "/download/split/" + path;
                $("#c1_" + i).attr("data-clipboard-text", url1);
                $("#c2_" + i).attr("data-clipboard-text", url2);
                $("#btn" + i + "_download").attr("href", url1);
            }
        }

        var clip;

        function copeText(id) {
            // set_btn_delayed("btn_"+i,4000);
            clip = new Clipboard("#" + id);
            // console.log(clipboard);
            clip.on('success', function (e) {
                e.clearSelection();
                // console.info('Action:', e.action);
                console.info('复制Text:', e.text);
                // console.info('Trigger:', e.trigger);
                alert('复制成功');
                clip.destroy();
            });
            clip.on('error', function (e) {
                alert('复制失败');
                console.error('Action:', e.action);
                console.error('Trigger:', e.trigger);
            });

        }

        function del(path) {
            if (confirm("确定删除该文件吗？")) {
                var key = $("#keys").val();
                if (key.length > 0) {
                    $.ajax({
                        url: '/upload/deleteFile',
                        method: "post",
                        dataType: "json",
                        data: {
                            key: key,
                            path: path
                        },
                        success: function (d) {
                            if (d.code == 200) {
                                sub2();
                            }
                            alert(d.message);
                        },
                        error: function (e) {
                            alert("删除错误：" + e);
                            console.log(e);
                        }
                    })
                } else {
                    alert("请输入管理访问秘钥");
                }
            }
        }

        /*模糊查询过滤*/
        function fuzzyQuery(list, keyWord) {
            var arr = list.filter(function (item) {
                var reg = new RegExp(keyWord, "gi");
                return reg.test(item.title)
            });
            return arr
        }

        function scrollToTop() {
            var timer = setInterval(function () {
                if (document.documentElement.scrollTop != 0) {
                    document.documentElement.scrollTop -= 100;
                } else {
                    clearInterval(timer);
                }
            }, 10);
        }
    </script>
</div>
</body>
</html>